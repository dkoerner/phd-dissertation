\section{Moment Expansion of the Radiative Transfer Equation}
\label{sec:da_moment_expansion_RTE}

As with the radiance field, the radiative transfer equation can be developed into its moments. The result is a concise representation of the $P_N$-equations, which are particularly expressive for lower truncation order, such as $P_1$. The derivation steps of the spherical harmonics expansion replaced the radiance field quantity in the RTE by its truncated expansion, followed by the expansion of the individual terms of the RTE. The derivation steps of the moment expansion are similar, with the difference, that the moment expansion (equation~\ref{eq:moment_expansion_mu}) is applied to the RTE terms (equation~\ref{eq:rte}) first and the, replacement is done as a second step.

The $n$-th moment of the RTE is found by applying the moment projection operator $\mu_n$ to all the terms of the RTE:
\begin{align*}
\mu_n\left[(\vec{\omega}\cdot\nabla)L(\vec{x}, \vec{\omega})\right]=&\\
\mu_n\left[-\sigma_t(\vec{x})L(\vec{x}, \vec{\omega}) + \sigma_s(\vec{x})\int_{\Omega}\phase(\vec{x}, \vec{\omega}'\rightarrow\vec{\omega})L(\vec{x}, \vec{\omega}')\ud\vec{\omega}' + Q(\vec{x}, \vec{\omega})\right]
%\label{eq:rte_ani}
\end{align*}
Since $\mu_n$ is linear, the LHS gives:
\begin{align*}
\mu_n[(\vec{\omega} \cdot \nabla)L(\vec{x}, \vec{\omega})] & = \int_{\Omega}{(\vec{\omega}\cdot\nabla)L(\vec{x}, \vec{\omega})N_n\ud\vec{\omega}}\\
							     & =\nabla\int_{S^2}{L(\vec{x}, \vec{\omega})N_n\vec{\omega}\ud\vec{\omega}} \\
							     & =\nabla\mu_{n+1}\left[L\right]
\end{align*}
The term $\nabla\mu_{n+1}$ is a tensor divergence. The general moment equation of the RTE for the $n$-th moment is:
\begin{align}
\nonumber
\nabla\mu_{n+1}\left[L\right] =&
-\sigma_t(\vec{x})\mu_n\left[L(\vec{x}, \vec{\omega})\right]\\
\label{eq:gme}
&+\sigma_s(\vec{x})\mu_n\left[\int_{\Omega}\phase(\vec{x}, \vec{\omega}'\rightarrow\vec{\omega}) L(\vec{x}, \vec{\omega}')\ud\vec{\omega}'\right]\\
\nonumber
&+\mu_n\left[Q(\vec{x}, \vec{\omega})\right]
\end{align}
Generally, the moment equations of the RTE relate the divergence of the $n+1$ moment of the radiance field, to the $n$-th moment of changes to the radiance field due to inscattering, absorption, and emission. The inscattering term convolves the radiance field with the phase function and applies the scattering coefficient as a weighting function on top. Each moment produces a number of equations, which are identical to the number of tensor components for a tensor of the rank associated with that moment.

For the derivation of the diffusion approximation in this chapter, the moment expansion of the RTE into its first two moments will be expanded. Expanding equation~\ref{eq:gme} with $n=0$ gives the zero moment equation:
\begin{align}
\nonumber
\nabla\vec{E}(\vec{x})=&
-\sigma_t(\vec{x})\mu_0\left[L(\vec{x}, \vec{\omega})\right]
\\
\label{eq:p1_zero}
&+ \sigma_s(\vec{x})\mu_0\left[\int_{\Omega}\phase(\vec{x}, \vec{\omega}'\rightarrow\vec{\omega})L(\vec{x}, \vec{\omega}')\ud\vec{\omega}'\right] 
\\
\nonumber
&+ \mu_0\left[Q(\vec{x}, \vec{\omega})\right]
\end{align}
The first moment equation is likewise found by using $n=1$ in equation~\ref{eq:gme}:
\begin{align}
\nonumber
\nabla P =&
-\sigma_t(\vec{x})\mu_1\left[L(\vec{x}, \vec{\omega})\right]
\\ &
\label{eq:p1_firstme}
+\sigma_s(\vec{x})\mu_1\left[\int_{\Omega}\phase(\vec{x}, \vec{\omega}'\rightarrow\vec{\omega})L(\vec{x}, \vec{\omega}')\ud\vec{\omega}'\right]
\\ &
\nonumber
+ \mu_1\left[Q(\vec{x}, \vec{\omega})\right]
\end{align}
$P=\mu_2[L]$ is the radiation pressure tensor, a $3\times3$ - matrix. The divergence of a second rank tensor is defined by tensor calculus to be the vector, containing the divergence of each single column vector of that tensor. Therefore, $\nabla P = \partial_i P_{ij}$.

The next step is to replace the radiance field $L$ by its two term expansion (equation~\ref{eq:moment_expansion_L}). Doing this with the zero moment expansion of the RTE (equation~\ref{eq:p1_zero}) gives:
\begin{align*}
\nabla\vec{E}\left(\vec{x}\right)=
&
-\sigma_t(\vec{x})\mu_0\left[\frac{1}{4\pi}\phi\left(\vec{x}\right) + \frac{3}{4\pi}\vec{E}\left(\vec{x}\right)\right]
\\
&
+\sigma_s(\vec{x})\mu_0\left[\int_{\Omega}\phase(\vec{x}, \vec{\omega}'\rightarrow\vec{\omega})\frac{1}{4\pi}\phi(\vec{x})\ud\vec{\omega}'\right]
\\
&
+\sigma_s(\vec{x})\mu_0\left[\int_{\Omega}\phase(\vec{x}, \vec{\omega}'\rightarrow\vec{\omega})\frac{3}{4\pi}\vec{E}(\vec{x})\ud\vec{\omega}'\right]
\\
&
\nonumber
+ Q_0\left(\vec{x}\right)
\\
=&
-\frac{1}{4\pi}\phi\sigma_t(\vec{x})\mu_0\left[1\right] - \frac{3}{4\pi}\vec{E}\left(\vec{x}\right)\sigma_t(\vec{x})\mu_1\left[1\right]
\\
&
+\frac{1}{4\pi}\phi(\vec{x})\sigma_s(\vec{x})\mu_0\left[\int_{\Omega}\phase(\vec{x}, \vec{\omega}'\rightarrow\vec{\omega})\ud\vec{\omega}'\right]
\\
&
+\frac{3}{4\pi}\vec{E}(\vec{x})\sigma_s(\vec{x})\mu_1\left[1\right]\int_{\Omega}\phase(\vec{x}, \vec{\omega}'\rightarrow\vec{\omega})\vec{\omega}'\ud\vec{\omega}'
\\
&
+ Q_0\left(\vec{x}\right)
\\
=&
-\phi(\vec{x})\sigma_t(\vec{x})
+\phi(\vec{x})\sigma_s(\vec{x})
+Q_0\left(\vec{x}\right)
\\
=&
-\phi(\vec{x})\sigma_a(\vec{x})
+Q_0\left(\vec{x}\right)
\end{align*}
Using $\mu_1[1] = 0$ and normalized phase function results in:
\begin{align*}
\mu_0\left[\int_{\Omega}\phase(\vec{x}, \vec{\omega}'\rightarrow\vec{\omega})\ud\vec{\omega}'\right] = \mu_0\left[1\right] = 4\pi
\end{align*}
Likewise the radiance field is replaced with its two moment expansion in the first moment expansion of the RTE (equation~\ref{eq:p1_firstme}):
\begin{align*}
\nabla P =&
-\sigma_t(\vec{x})\mu_1\left[\frac{1}{4\pi}\phi\left(\vec{x}\right) + \frac{3}{4\pi}\vec{E}\left(\vec{x}\right)\right]
\\&
+\sigma_s(\vec{x})\mu_1\left[\int_{\Omega}\phase(\vec{x}, \vec{\omega}'\rightarrow\vec{\omega})\left(\frac{1}{4\pi}\phi\left(\vec{x}\right) + \frac{3}{4\pi}\vec{E}\left(\vec{x}\right)\right)\ud\vec{\omega}'\right]
\\&
\nonumber
+ Q_1\left(\vec{x}\right)
\\
=&
-\sigma_t(\vec{x})\mu_1\left[\frac{1}{4\pi}\phi\left(\vec{x}\right)\right]
-\sigma_t(\vec{x})\mu_1\left[\frac{3}{4\pi}\vec{E}\left(\vec{x}\right)\right]
\\
&
+\frac{1}{4\pi}\phi\left(\vec{x}\right)\sigma_s(\vec{x})\mu_1\left[\int_{\Omega}\phase(\vec{x}, \vec{\omega}'\rightarrow\vec{\omega})\ud\vec{\omega}'\right]
\\
&
+\frac{3}{4\pi}\vec{E}\left(\vec{x}\right)\sigma_s(\vec{x})\mu_1\left[\int_{\Omega}\phase(\vec{x}, \vec{\omega}'\rightarrow\vec{\omega})\vec{\omega}\ud\vec{\omega}'\right]
\\
&
+Q_1\left(\vec{x}\right)
\\
=&
-\frac{1}{4\pi}\phi\left(\vec{x}\right)\sigma_t(\vec{x})\mu_1\left[1\right]
-\frac{3}{4\pi}\vec{E}\left(\vec{x}\right)\sigma_t(\vec{x})\mu_2\left[1\right]
\\
&
+\frac{1}{4\pi}\phi\left(\vec{x}\right)\sigma_s(\vec{x})\mu_1\left[1\right]
\\
&
+\frac{3}{4\pi}\vec{E}\left(\vec{x}\right)\sigma_s(\vec{x})\mu_1\left[\mu_1\left[f\right]\right]
\\
&
+Q_1\left(\vec{x}\right)
\\
=&
-\frac{3}{4\pi}\vec{E}\left(\vec{x}\right)\sigma_t(\vec{x})\mu_2\left[1\right]
+\frac{3}{4\pi}\vec{E}\left(\vec{x}\right)g\sigma_s(\vec{x})\mu_2\left[1\right]
\\
=&
\left(-\sigma_t(\vec{x})\mathbf{I} + g\sigma_s(\vec{x})\mathbf{I}\right)\vec{E}\left(\vec{x}\right)
+Q_1\left(\vec{x}\right)
\\
=&
-\sigma_t'(\vec{x})\vec{E}\left(\vec{x}\right)
+Q_1\left(\vec{x}\right)
\end{align*}
Here, the following is used
\begin{align*}
\mu_2[1] = \frac{4\pi}{3}\mathbf{I}
\end{align*}
along with that the first moment of a phase function, which only depends on the angle between incident and outgoing direction, is its mean cosine $g$.

The quantity $\sigma_t'$ is called the reduced extinction coefficient and it is defined as:
\begin{align*}
\sigma_t' = \sigma_t - g\sigma_s
\end{align*}
We obtain the two term expansion of the radiative transfer equation:
\begin{align}
\label{eq:me_zero}
\nabla\vec{E}\left(\vec{x}\right)&=
-\phi(\vec{x})\sigma_a(\vec{x})
+Q_0\left(\vec{x}\right)
\\
\label{eq:me_first}
\nabla P\left(\vec{x}\right) &= -\sigma_t'(\vec{x})\vec{E}\left(\vec{x}\right)
+Q_1\left(\vec{x}\right)
\end{align}
These equations are the direct counterpart to the $P_1$-equations in the moment expansion form. The diffusion approximation can be derived by taking the first moment equations and inserting them into the zero moment equations by substituting $\vec{E}$. The same procedure can be carried out for the $P_1$-equations (using spherical harmonics coefficients). However, the notation of the moment expansion is more expressive, which is the reason for its popularity in the literature.

Equation~\ref{eq:me_first} is solved for $\vec{E}$ as follows:
\begin{align}
\label{eq:me_first_resolved_E}
\vec{E}\left(\vec{x}\right) =
-\frac{1}{\sigma_t'\left(\vec{x}\right)}
\left(
\nabla P\left(\vec{x}\right)
-Q_1\left(\vec{x}\right)
\right)
\end{align}
Then equation~\ref{eq:me_first_resolved_E} is used to substitute $\vec{E}$ in equation~\ref{eq:me_zero}. This way, the unknown $\vec{E}$ is eliminated and we arrive at a single scalar partial differential equation:
\begin{align}
\nabla
\left(
-\frac{1}{\sigma_t'\left(\vec{x}\right)}
\left(
\nabla P\left(\vec{x}\right)
-Q_1\left(\vec{x}\right)
\right)
\right)&=
-\phi(\vec{x})\sigma_a(\vec{x})
+Q_0\left(\vec{x}\right)
\ ,
\end{align}
which can be further rearranged into:
\begin{align}
\label{eq:general_diffusion_equation}
\nabla
\left(
-\frac{1}{\sigma_t'\left(\vec{x}\right)}
\nabla P\left(\vec{x}\right)
\right)&=
-\phi(\vec{x})\sigma_a(\vec{x})
+Q_0\left(\vec{x}\right)
+\nabla Q_1\left(\vec{x}\right)
.
\end{align}
A single unknown remains: the second moment of the radiance field $P$, which is called the radiative pressure tensor. Resolving, or better approximating, this unknown is what leads to a rich variety of methods and theories, including the diffusion approximation and flux-limited diffusion.
